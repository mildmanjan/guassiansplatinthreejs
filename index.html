<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gaussian Splat Portal Gallery</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            overflow: hidden;
            background: #000;
        }
        #canvas-container {
            width: 100vw;
            height: 100vh;
        }
        #instructions {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            font-size: 14px;
            max-width: 300px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(74, 158, 255, 0.3);
            z-index: 100;
        }
        #instructions h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #4a9eff;
        }
        #instructions ul {
            list-style: none;
            padding: 0;
        }
        #instructions li {
            margin: 8px 0;
            padding-left: 20px;
            position: relative;
        }
        #instructions li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: #4a9eff;
        }
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 20px;
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 10px;
            min-width: 300px;
            z-index: 1000;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #4a9eff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #portal-prompt {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(74, 158, 255, 0.9);
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 18px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 200;
        }
        #portal-prompt.show {
            opacity: 1;
        }
        #file-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            font-family: monospace;
            z-index: 100;
        }
        #gallery-info {
            position: fixed;
            top: 20px;
            right: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            font-size: 14px;
            max-width: 300px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(74, 158, 255, 0.3);
            z-index: 100;
        }
        #gallery-info h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #4a9eff;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <div id="loading">
        <div class="spinner"></div>
        <div id="loading-text">Loading Gallery...</div>
    </div>
    
    <div id="instructions" style="display: none;">
        <h2>üåÄ Gallery Controls</h2>
        <ul>
            <li>Left click + drag to orbit</li>
            <li>Scroll to zoom in/out</li>
            <li>Click any portal to enter</li>
            <li>Each portal shows different view</li>
        </ul>
    </div>
    
    <div id="gallery-info" style="display: none;">
        <h2>üìä Portal Methods</h2>
        <div style="font-size: 12px; line-height: 1.8;">
            <div style="color: #4a9eff;">‚óè Portal 1: Parallax (0.5)</div>
            <div style="color: #ff6b6b;">‚óè Portal 2: Parallax (0.3)</div>
            <div style="color: #51cf66;">‚óè Portal 3: Parallax (0.1)</div>
        </div>
    </div>
    
    <div id="file-info" style="display: none;">
        <div>üìÅ Gallery loaded successfully</div>
        <div>üé® <span id="portal-count">0</span> Portals Active</div>
    </div>

    <div id="portal-prompt">
        Click portal to enter the 3D scene!
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import * as GaussianSplats3D from 'https://cdn.jsdelivr.net/npm/@mkkellogg/gaussian-splats-3d@latest/build/gaussian-splats-3d.module.min.js';

        // ====== PORTAL CONFIGURATION ======
        // ‚úÖ Using EXACT same URL as your working single portal
        const PORTAL_CONFIGS = [
            {
                name: "Parallax Strong (0.5)",
                splatFile: "https://huggingface.co/mysterytreebeast/gaussian-splat-models/resolve/main/frontroom_1506.ply",
                //splatFile: "frontroom_1506.ply",
                position: { x: -5, y: 1.5, z: -5 },
                color: 0x4a9eff,
                parallaxStrength: 0.5,
                scale: 5
            },
            {
                name: "Parallax Medium (0.3)",
                splatFile: "https://huggingface.co/mysterytreebeast/gaussian-splat-models/resolve/main/InteriorDesign.ply",
                position: { x: 0, y: 1.5, z: -6 },
                color: 0xff6b6b,
                parallaxStrength: 0.3,
                scale: 5
            },
            {
                name: "Parallax Subtle (0.1)",
                splatFile: "https://huggingface.co/mysterytreebeast/gaussian-splat-models/resolve/main/InteriorDesign.ply",
                position: { x: 5, y: 1.5, z: -5 },
                color: 0x51cf66,
                parallaxStrength: 0.1,
                scale: 5
            }
        ];

        // ====== MAIN SCENE SETUP ======
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a0a);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 1.6, 8);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 3;
        controls.maxDistance = 20;
        controls.maxPolarAngle = Math.PI / 2;
        controls.target.set(0, 1.6, -3);

        // ====== DRAMATIC LIGHTING (from working code) ======
        scene.add(new THREE.AmbientLight(0x111111, 0.2));

        const spotlight1 = new THREE.SpotLight(0x4a9eff, 10);
        spotlight1.position.set(-5, 8, -3);
        spotlight1.angle = Math.PI / 5;
        spotlight1.penumbra = 0.6;
        spotlight1.decay = 1.5;
        spotlight1.distance = 20;
        spotlight1.castShadow = true;
        spotlight1.target.position.set(-5, 1.5, -5);
        scene.add(spotlight1);
        scene.add(spotlight1.target);

        const spotlight2 = new THREE.SpotLight(0xff3333, 10);
        spotlight2.position.set(0, 8, -4);
        spotlight2.angle = Math.PI / 5;
        spotlight2.penumbra = 0.6;
        spotlight2.decay = 1.5;
        spotlight2.distance = 20;
        spotlight2.castShadow = true;
        spotlight2.target.position.set(0, 1.5, -6);
        scene.add(spotlight2);
        scene.add(spotlight2.target);

        const spotlight3 = new THREE.SpotLight(0xaaccff, 10);
        spotlight3.position.set(5, 8, -3);
        spotlight3.angle = Math.PI / 5;
        spotlight3.penumbra = 0.7;
        spotlight3.decay = 1.5;
        spotlight3.distance = 20;
        spotlight3.castShadow = true;
        spotlight3.target.position.set(5, 1.5, -5);
        scene.add(spotlight3);
        scene.add(spotlight3.target);

        // ====== ROOM GEOMETRY (from working code) ======
        const floor = new THREE.Mesh(
            new THREE.PlaneGeometry(30, 30),
            new THREE.MeshStandardMaterial({ color: 0x1fffff })
        );
        floor.rotation.x = -Math.PI / 2;
        floor.position.y = -1;
        floor.receiveShadow = true;
        scene.add(floor);

        const wallMat = new THREE.MeshStandardMaterial({ 
            color: 0xffffff, 
            side: THREE.DoubleSide 
        });
        const backWall = new THREE.Mesh(new THREE.PlaneGeometry(30, 10), wallMat);
        backWall.position.set(0, 4, -8);
        backWall.receiveShadow = true;
        scene.add(backWall);

        const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(20, 10), wallMat);
        leftWall.position.set(-10, 4, 0);
        leftWall.rotation.y = Math.PI / 2;
        leftWall.receiveShadow = true;
        scene.add(leftWall);

        const rightWall = new THREE.Mesh(new THREE.PlaneGeometry(20, 10), wallMat);
        rightWall.position.set(10, 4, 0);
        rightWall.rotation.y = -Math.PI / 2;
        rightWall.receiveShadow = true;
        scene.add(rightWall);

        const cube = new THREE.Mesh(
            new THREE.BoxGeometry(0.8, 0.8, 0.8),
            new THREE.MeshStandardMaterial({ color: 0xFFFF00 })
        );
        cube.position.set(-1, 0, -5);
        cube.castShadow = true;
        cube.receiveShadow = true;
        scene.add(cube);

        // ====== PORTAL SYSTEM ======
        const portals = [];
        let activePortalIndex = -1;
        let isInSplatScene = false;
        let splatControls = null;

        function createSplatControls() {
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 0.5;
            controls.maxDistance = 50;
            controls.enabled = false;
            return controls;
        }

        splatControls = createSplatControls();

        /**
         * Create portal - EXACTLY MATCHING working single portal structure
         */
        async function createPortal(config, index) {
            console.log(`\nüî∑ Creating portal ${index}: ${config.name}`);

            // ‚úÖ EXACT STRUCTURE from working code
            const portalScene = new THREE.Scene();
            portalScene.background = new THREE.Color(0x1a1a2a);
            
            // ‚úÖ EXACT camera setup from working code
            const portalCamera = new THREE.PerspectiveCamera(60, 1, 0.1, 100);
            portalCamera.position.set(0, 1, 3);
            portalCamera.lookAt(0, 0, 0);
            
            // ‚úÖ EXACT lighting from working code
            portalScene.add(new THREE.AmbientLight(0xffffff, 0.8));
            const portalDirLight = new THREE.DirectionalLight(0xffffff, 0.5);
            portalDirLight.position.set(5, 5, 5);
            portalScene.add(portalDirLight);
            
            // ‚úÖ EXACT render target from working code
            const portalRenderTarget = new THREE.WebGLRenderTarget(2048, 2048, {
                minFilter: THREE.LinearFilter,
                magFilter: THREE.LinearFilter,
                format: THREE.RGBAFormat
            });

            // Create portal geometry
            const portalGroup = new THREE.Group();
            portalGroup.position.set(config.position.x, config.position.y, config.position.z);

            const frame = new THREE.Mesh(
                new THREE.BoxGeometry(2.2, 3.2, 0.1),
                new THREE.MeshStandardMaterial({ 
                    color: 0x1a1a1a,
                    metalness: 0.8,
                    roughness: 0.2 
                })
            );
            frame.castShadow = true;
            frame.receiveShadow = true;
            portalGroup.add(frame);

            const portalSurface = new THREE.Mesh(
                new THREE.PlaneGeometry(2, 3),
                new THREE.MeshBasicMaterial({ 
                    map: portalRenderTarget.texture,
                    side: THREE.DoubleSide
                })
            );
            portalSurface.position.z = 0.06;
            portalGroup.add(portalSurface);

            const glow = new THREE.Mesh(
                new THREE.PlaneGeometry(2.1, 3.1),
                new THREE.MeshBasicMaterial({ 
                    color: config.color,
                    transparent: true,
                    opacity: 0.2,
                    side: THREE.DoubleSide
                })
            );
            glow.position.z = 0.05;
            portalGroup.add(glow);

            scene.add(portalGroup);

            // ‚úÖ EXACT splat loading from working code
            let splatViewer = null;
            try {
                console.log(`   üìÑ Loading splat...`);
                
                splatViewer = new GaussianSplats3D.Viewer({
                    threeScene: portalScene,
                    renderer: renderer,
                    camera: portalCamera,
                    selfDrivenMode: false,
                    useBuiltInControls: false,
                    showLoadingSpinner: false,
                    gpuAcceleratedSort: false,
                    integerBasedSort: false,
                    sharedMemoryForWorkers: false,
                    enableSplatSorting: true,
                    halfPrecisionCovariancesOnGPU: true,
                    dynamicScene: false,
                    webXRMode: GaussianSplats3D.WebXRMode.None,
                    renderMode: GaussianSplats3D.RenderMode.Always,
                    logLevel: GaussianSplats3D.LogLevel.Info
                });

                await splatViewer.init();
                console.log(`   ‚úÖ Viewer initialized`);

                await splatViewer.addSplatScene(config.splatFile, {
                    progressiveLoad: true,
                    splatAlphaRemovalThreshold: 5,
                    position: [0, 0, 0],
                    rotation: [1, 0, 0, 0],
                    scale: [config.scale, config.scale, config.scale]
                });

                console.log(`   ‚úÖ Portal ${index} splat loaded!`);

            } catch (error) {
                console.error(`   ‚ùå Portal ${index} failed:`, error);
            }

            portals.push({
                index,
                config,
                group: portalGroup,
                scene: portalScene,
                camera: portalCamera,
                renderTarget: portalRenderTarget,
                viewer: splatViewer,
                glow
            });

            return portals[portals.length - 1];
        }

        /**
         * Update portal camera - simple parallax
         */
        function updatePortalCamera(portal) {
            const portalPos = portal.group.position;
            const cameraToPortal = new THREE.Vector3().subVectors(camera.position, portalPos);
            const strength = portal.config.parallaxStrength;

            portal.camera.position.x = -cameraToPortal.x * strength;
            portal.camera.position.y = cameraToPortal.y * strength + 1;
            portal.camera.position.z = cameraToPortal.z * strength + 5;
            portal.camera.lookAt(0, 0, 0);
        }

        // ====== PORTAL INTERACTION ======
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        renderer.domElement.addEventListener('click', (event) => {
            if (isInSplatScene) return;

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            portals.forEach((portal) => {
                const intersects = raycaster.intersectObjects(portal.group.children, true);
                if (intersects.length > 0) {
                    enterPortal(portal.index);
                }
            });
        });

        function updatePortalProximity() {
            if (isInSplatScene) return;

            let nearPortal = false;
            portals.forEach(portal => {
                const distance = camera.position.distanceTo(portal.group.position);
                if (distance < 6) nearPortal = true;
            });

            const prompt = document.getElementById('portal-prompt');
            if (nearPortal) {
                prompt.classList.add('show');
            } else {
                prompt.classList.remove('show');
            }
        }

  function enterPortal(portalIndex) {
            console.log(`üö™ Entering portal ${portalIndex}`);
            isInSplatScene = true;
            activePortalIndex = portalIndex;

            controls.enabled = false;
            splatControls.enabled = true;

            // ‚úÖ CRITICAL: Switch viewer to use main camera
            const activePortal = portals[portalIndex];
            if (activePortal && activePortal.viewer) {
                activePortal.viewer.camera = camera;
                console.log('‚úÖ Switched viewer to main camera');
            }

            camera.position.set(0, 2, 8);
            camera.lookAt(0, 0, 0);
            splatControls.target.set(0, 0, 0);
            splatControls.update();

            scene.background = new THREE.Color(0x1a1a2a);

            floor.visible = false;
            backWall.visible = false;
            leftWall.visible = false;
            rightWall.visible = false;
            cube.visible = false;
            portals.forEach(p => p.group.visible = false);
            spotlight1.visible = false;
            spotlight2.visible = false;
            spotlight3.visible = false;

            document.getElementById('instructions').innerHTML = `
                <h2>üåÄ Inside ${portals[portalIndex].config.name}</h2>
                <ul>
                    <li>Drag to rotate view</li>
                    <li>Scroll to zoom in/out</li>
                    <li>Explore the 3D space!</li>
                    <li>Press ESC to exit</li>
                </ul>
            `;

            document.getElementById('portal-prompt').classList.remove('show');
        }

        function exitPortal() {
            console.log('üö™ Exiting portal...');
            
            // ‚úÖ CRITICAL: Restore portal camera
            const activePortal = portals[activePortalIndex];
            if (activePortal && activePortal.viewer) {
                activePortal.viewer.camera = activePortal.camera;
                console.log('‚úÖ Restored portal camera');
            }

            isInSplatScene = false;
            activePortalIndex = -1;

            controls.enabled = true;
            splatControls.enabled = false;

            camera.position.set(0, 1.6, 8);
            controls.target.set(0, 1.6, -3);
            controls.update();

            scene.background = new THREE.Color(0x0a0a0a);

            floor.visible = true;
            backWall.visible = true;
            leftWall.visible = true;
            rightWall.visible = true;
            cube.visible = true;
            portals.forEach(p => p.group.visible = true);
            spotlight1.visible = true;
            spotlight2.visible = true;
            spotlight3.visible = true;

            document.getElementById('instructions').innerHTML = `
                <h2>üåÄ Gallery Controls</h2>
                <ul>
                    <li>Left click + drag to orbit</li>
                    <li>Scroll to zoom in/out</li>
                    <li>Click any portal to enter</li>
                    <li>Each portal shows different view</li>
                </ul>
            `;
        }

        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && isInSplatScene) {
                exitPortal();
            }
        });

        // ====== ANIMATION LOOP ======
  // ====== ANIMATION LOOP ======
        function animate() {
            requestAnimationFrame(animate);

            if (isInSplatScene) {
                // Inside portal: render splat scene with main camera
                splatControls.update();

                const activePortal = portals[activePortalIndex];
                if (activePortal && activePortal.viewer) {
                    activePortal.viewer.update();
                    
                    // ‚úÖ CRITICAL: Must call viewer.render() for splat to show
                    renderer.setRenderTarget(null);
                    activePortal.viewer.render();  // This renders the splat!
                }
            } else {
                // Outside: render gallery with portal previews
                controls.update();
                updatePortalProximity();

                cube.rotation.x += 0.005;
                cube.rotation.y += 0.005;

                // Render each portal to its texture
                portals.forEach(portal => {
                    updatePortalCamera(portal);

                    if (portal.viewer) {
                        portal.viewer.update();
                        
                        // ‚úÖ CRITICAL: Render splat to portal texture
                        renderer.setRenderTarget(portal.renderTarget);
                        portal.viewer.render();  // This renders the splat to texture!
                        renderer.setRenderTarget(null);
                    }

                    const time = Date.now() * 0.001;
                    portal.glow.material.opacity = 0.2 + Math.sin(time * 2 + portal.index) * 0.1;
                });

                // Render main gallery scene
                renderer.render(scene, camera);
            }
        }

        // ====== INITIALIZATION ======
        async function init() {
            document.getElementById('loading-text').textContent = 'Creating portal gallery...';

            for (let i = 0; i < PORTAL_CONFIGS.length; i++) {
                document.getElementById('loading-text').textContent = `Loading portal ${i + 1}/${PORTAL_CONFIGS.length}...`;
                await createPortal(PORTAL_CONFIGS[i], i);
            }

            document.getElementById('portal-count').textContent = portals.length;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('instructions').style.display = 'block';
            document.getElementById('gallery-info').style.display = 'block';
            document.getElementById('file-info').style.display = 'block';

            animate();
            console.log('üåÄ Portal gallery ready!');
        }

        // ====== WINDOW RESIZE ======
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // ====== START ======
        init().catch(err => {
            console.error('Init failed:', err);
            document.getElementById('loading-text').textContent = 'Error: ' + err.message;
        });
    </script>
</body>
</html>